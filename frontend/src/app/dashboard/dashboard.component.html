<div class="container mx-auto p-4">
  <div class="grid grid-cols-1 gap-4">
    <div
      *ngFor="let identity of identities; let i = index"
      class="bg-white shadow overflow-hidden sm:rounded-lg mb-4"
    >
      <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
        <div class="flex items-center">
          <img
            class="h-10 w-10 rounded-full"
            src="https://via.placeholder.com/40"
            alt="Avatar"
          />
          <div class="ml-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900">
              {{ identity.title || "Create New Identity" }}
            </h3>
            <p class="text-sm text-gray-500">
              {{ identity.description || "" }}
            </p>
          </div>
        </div>
        <ng-container *ngIf="identity.id">
          <div class="relative">
            <button
              (click)="toggleMenu(i)"
              class="text-gray-500 hover:text-gray-700"
            >
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M6 10c0 1.105-.895 2-2 2S2 11.105 2 10s.895-2 2-2 2 .895 2 2zM10 12c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2zM14 12c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2z"
                />
              </svg>
            </button>
            <div
              *ngIf="menuOpen[i]"
              class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-10"
            >
              <button
                (click)="editIdentity(i)"
                class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
              >
                Edit
              </button>
              <button
                (click)="deleteIdentity(identity.id!)"
                class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
              >
                Delete
              </button>
            </div>
          </div>
        </ng-container>
      </div>
      <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
        <ng-container *ngIf="!identity.id">
          <form (ngSubmit)="onSubmitIdentity(i)" class="w-full">
            <div class="mb-4">
              <label
                for="title{{ i }}"
                class="block text-sm font-medium text-gray-700"
                >Title:</label
              >
              <input
                type="text"
                id="title{{ i }}"
                [(ngModel)]="identities[i].title"
                name="title{{ i }}"
                class="mt-1 p-2 border border-gray-300 rounded-md w-full"
                required
              />
            </div>
            <div class="mb-4">
              <label
                for="description{{ i }}"
                class="block text-sm font-medium text-gray-700"
                >Description:</label
              >
              <input
                type="text"
                id="description{{ i }}"
                [(ngModel)]="identities[i].description"
                name="description{{ i }}"
                class="mt-1 p-2 border border-gray-300 rounded-md w-full"
                required
              />
            </div>
            <button
              type="submit"
              class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-700 w-full"
            >
              Create Identity
            </button>
          </form>
        </ng-container>
        <ng-container *ngIf="identity.id">
          <button
            (click)="addTaskForm(i)"
            class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-700 mt-4"
          >
            Add Task
          </button>
          <div *ngFor="let task of tasks[i]; let j = index" class="mt-4">
            <ng-container *ngIf="!task.created">
              <form (ngSubmit)="onSubmitTask(i, j)" class="w-full">
                <div class="mb-4">
                  <label
                    for="taskTitle{{ i }}{{ j }}"
                    class="block text-sm font-medium text-gray-700"
                    >Task Title:</label
                  >
                  <input
                    type="text"
                    id="taskTitle{{ i }}{{ j }}"
                    [(ngModel)]="tasks[i][j].title"
                    name="taskTitle{{ i }}{{ j }}"
                    class="mt-1 p-2 border border-gray-300 rounded-md w-full"
                    required
                  />
                </div>
                <div class="mb-4">
                  <label
                    for="taskDescription{{ i }}{{ j }}"
                    class="block text-sm font-medium text-gray-700"
                    >Task Description:</label
                  >
                  <input
                    type="text"
                    id="taskDescription{{ i }}{{ j }}"
                    [(ngModel)]="tasks[i][j].description"
                    name="taskDescription{{ i }}{{ j }}"
                    class="mt-1 p-2 border border-gray-300 rounded-md w-full"
                    required
                  />
                </div>
                <div class="mb-4">
                  <label
                    for="taskCue{{ i }}{{ j }}"
                    class="block text-sm font-medium text-gray-700"
                    >Task Cue:</label
                  >
                  <input
                    type="text"
                    id="taskCue{{ i }}{{ j }}"
                    [(ngModel)]="tasks[i][j].cue"
                    name="taskCue{{ i }}{{ j }}"
                    class="mt-1 p-2 border border-gray-300 rounded-md w-full"
                    required
                  />
                </div>
                <div class="mb-4">
                  <label
                    for="taskCraving{{ i }}{{ j }}"
                    class="block text-sm font-medium text-gray-700"
                    >Task Craving:</label
                  >
                  <input
                    type="text"
                    id="taskCraving{{ i }}{{ j }}"
                    [(ngModel)]="tasks[i][j].craving"
                    name="taskCraving{{ i }}{{ j }}"
                    class="mt-1 p-2 border border-gray-300 rounded-md w-full"
                    required
                  />
                </div>
                <div class="mb-4">
                  <label
                    for="taskResponse{{ i }}{{ j }}"
                    class="block text-sm font-medium text-gray-700"
                    >Task Response:</label
                  >
                  <input
                    type="text"
                    id="taskResponse{{ i }}{{ j }}"
                    [(ngModel)]="tasks[i][j].response"
                    name="taskResponse{{ i }}{{ j }}"
                    class="mt-1 p-2 border border-gray-300 rounded-md w-full"
                    required
                  />
                </div>
                <div class="mb-4">
                  <label
                    for="taskReward{{ i }}{{ j }}"
                    class="block text-sm font-medium text-gray-700"
                    >Task Reward:</label
                  >
                  <input
                    type="text"
                    id="taskReward{{ i }}{{ j }}"
                    [(ngModel)]="tasks[i][j].reward"
                    name="taskReward{{ i }}{{ j }}"
                    class="mt-1 p-2 border border-gray-300 rounded-md w-full"
                    required
                  />
                </div>
                <button
                  type="submit"
                  class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-700 w-full"
                >
                  Create Task
                </button>
              </form>
            </ng-container>
            <ng-container *ngIf="task.created">
              <div
                class="bg-white shadow overflow-hidden sm:rounded-lg mb-4 p-4 flex justify-between items-center"
              >
                <div>
                  <h3 class="text-lg leading-6 font-medium text-gray-900">
                    {{ task.title }}
                  </h3>
                  <p class="text-sm text-gray-500">{{ task.description }}</p>
                  <p class="text-sm text-gray-500">{{ task.cue }}</p>
                  <p class="text-sm text-gray-500">{{ task.craving }}</p>
                  <p class="text-sm text-gray-500">{{ task.response }}</p>
                  <p class="text-sm text-gray-500">{{ task.reward }}</p>
                </div>
                <div>
                  <input
                    type="checkbox"
                    [checked]="task.completed"
                    (change)="toggleCompleteTask(i, j)"
                  />
                </div>
              </div>
            </ng-container>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>
